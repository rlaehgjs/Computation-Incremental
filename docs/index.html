<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Computation-Incremental</title>
    <script src="https://cdn.jsdelivr.net/npm/break_eternity.js"></script>
    <style>
        :root {
            --neon: #00ff41;
            --bg: #050505;
            --white: #eee;
            --gray: #444;
            --panel-bg: #0a0a0a;
        }

        body {
            background: var(--bg);
            color: var(--white);
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tab-nav {
            width: 900px;
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            background: #111;
            border: 1px solid #333;
            color: #888;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: 0.2s;
        }

        .tab-btn:hover {
            background: #1a1a1a;
            color: #ccc;
        }

        .tab-btn.active {
            background: var(--panel-bg);
            border-color: var(--neon);
            color: var(--neon);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.1);
        }

        .tab-content {
            display: none;
            width: 900px;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header {
            width: 900px;
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #222;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .bits-count {
            font-size: 28px;
            transition: 0.3s;
        }

        .bits-count.affordable {
            color: var(--neon);
            text-shadow: 0 0 10px var(--neon);
        }

        /* íŒ¨ë„ ë ˆì´ì•„ì›ƒ ìˆ˜ì • */
        .panel-container {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 30px;
            width: 100%;
        }

        .panel {
            border: 1px solid #333;
            padding: 20px;
            background: var(--panel-bg);
            border-radius: 8px;
            min-height: 450px;
            position: relative;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .help-btn {
            background: none;
            border: 1px solid #333;
            color: #666;
            cursor: pointer;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            position: relative;
            vertical-align: middle;
            flex-shrink: 0;
        }

        .help-btn .tooltip {
            visibility: hidden;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel-bg);
            border: 1px solid var(--neon);
            color: var(--white);
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 11px;
            z-index: 1000;
            pointer-events: none;
            display: block;
            width: auto;
            min-width: 200px;
            max-width: 400px;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            text-align: left;
            box-sizing: border-box;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .help-btn:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .help-btn:hover .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--neon);
            margin-bottom: -5px;
        }

        /* íšŒë¡œ ì˜ì—­ (ë¡œê·¸ ìœ„ë¡œ ì´ë™) */
        #circuit-area {
            width: 100%;
            background: var(--panel-bg);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 200px;
        }

        #bulb-grid {
            display: grid;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }

        .bulb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #1a1a1a;
            border: 2px solid #333;
            transition: background 0.05s, box-shadow 0.05s;
        }

        .bulb.on {
            background: #ffca28;
            border-color: #ffca28;
            box-shadow: 0 0 15px #ffca28, 0 0 5px #fff;
            z-index: 10;
        }

        button.action-btn {
            background: #111;
            color: var(--white);
            border: 1px solid var(--gray);
            padding: 12px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            text-align: left;
            border-radius: 4px;
            position: relative;
            transition: 0.2s;
        }

        button.action-btn:hover:not(:disabled) {
            border-color: var(--neon);
            background: #161616;
            transform: translateX(2px);
        }

        button.action-btn.affordable {
            color: var(--neon);
            border-color: var(--neon);
        }

        button.action-btn:disabled {
            opacity: 0.75;
            cursor: not-allowed;
        }

        .rank-title {
            font-size: 16px;
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
        }

        .cost-text {
            font-size: 13px;
            color: #aaa;
            position: absolute;
            top: 12px;
            right: 12px;
        }

        button.action-btn.affordable .cost-text {
            color: var(--neon);
        }

        .effect-info {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            display: block;
        }

        .milestones {
            border-top: 1px dashed #333;
            padding-top: 6px;
            margin-top: 8px;
            font-size: 11px;
        }

        .ms-item {
            margin-bottom: 2px;
        }

        .ms-active {
            color: var(--neon);
            font-weight: bold;
        }

        .ms-future {
            color: #555;
        }

        .log {
            height: 100px;
            overflow-y: hidden;
            border: 1px solid #222;
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            width: 900px;
            padding: 10px;
            background: #000;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        .stat-line {
            padding: 8px;
            border-bottom: 1px solid #222;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-label {
            color: var(--neon);
            font-weight: bold;
            white-space: nowrap;
        }

        .setting-btn {
            background: #222;
            border: 1px solid #555;
            color: #eee;
            padding: 10px 20px;
            margin-bottom: 10px;
            cursor: pointer;
            width: 100%;
            text-align: left;
        }

        .setting-btn:hover {
            background: #333;
            border-color: #888;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-title {
            color: var(--neon);
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .sub-tab-nav {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid #222;
            padding-bottom: 10px;
        }

        .sub-tab-btn {
            background: #111;
            border: 1px solid #333;
            color: #666;
            padding: 5px 15px;
            cursor: pointer;
            font-size: 12px;
            border-radius: 4px;
            transition: 0.2s;
        }

        .sub-tab-btn:hover {
            color: #aaa;
            border-color: #555;
        }

        .sub-tab-btn.active {
            background: #222;
            color: var(--neon);
            border-color: var(--neon);
        }

        /* ì»·ì‹  ë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
        #cutscene-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }

        #cutscene-image-container {
            width: 80%;
            height: 60%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border: 1px solid #222;
            background: #050505;
        }

        #cutscene-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: opacity 0.5s;
        }

        #cutscene-text-box {
            width: 80%;
            min-height: 100px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid var(--neon);
            padding: 20px;
            box-sizing: border-box;
            color: var(--white);
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px #000;
            backdrop-filter: blur(5px);
        }

        .cutscene-controls {
            display: flex;
            gap: 20px;
            width: 80%;
        }

        .cutscene-btn {
            padding: 12px 30px;
            background: transparent;
            border: 1px solid var(--neon);
            color: var(--neon);
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: 0.3s;
        }

        .cutscene-btn:hover {
            background: var(--neon);
            color: #000;
            box-shadow: 0 0 15px var(--neon);
        }

        .cutscene-btn:disabled {
            border-color: #333;
            color: #333;
            cursor: not-allowed;
            box-shadow: none;
        }

        .skip-btn {
            margin-left: auto;
            border-color: #666;
            color: #666;
        }

        .skip-btn:hover {
            border-color: #fff;
            color: #fff;
            background: transparent;
            box-shadow: 0 0 10px #fff;
        }

        /* ì±•í„° íƒ€ì´í‹€ ì—°ì¶œ ìŠ¤íƒ€ì¼ */
        #chapter-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s;
        }

        #chapter-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .chapter-bulb-icon {
            width: 80px;
            height: 80px;
            fill: var(--neon);
            filter: drop-shadow(0 0 10px var(--neon));
            margin-bottom: 20px;
            opacity: 0;
            transform: translateY(20px);
        }

        .chapter-bulb-icon.animate {
            animation: fadeInRise 1s forwards 0.5s;
        }

        #chapter-main-text {
            font-size: 48px;
            font-weight: bold;
            color: var(--white);
            letter-spacing: 15px;
            margin: 0;
            transform: scaleX(0);
            transform-origin: center;
            white-space: nowrap;
        }

        #chapter-main-text.animate {
            animation: expandHorizontal 1.2s cubic-bezier(0.87, 0, 0.13, 1) forwards 1s;
        }

        #chapter-sub-text {
            font-size: 20px;
            color: var(--neon);
            margin-top: 15px;
            opacity: 0;
            letter-spacing: 8px;
        }

        #chapter-sub-text.animate {
            animation: fadeInLetterSpacing 1.5s ease-out forwards 2s;
        }

        @keyframes expandHorizontal {
            from {
                transform: scaleX(0);
            }

            to {
                transform: scaleX(1);
            }
        }

        @keyframes fadeInRise {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInLetterSpacing {
            from {
                opacity: 0;
                letter-spacing: 25px;
            }

            to {
                opacity: 1;
                letter-spacing: 8px;
            }
        }
    </style>
</head>

<body>

    <div id="cutscene-overlay" class="hidden">
        <div id="cutscene-image-container">
            <img id="cutscene-image" src="" alt="Story Image">
        </div>
        <div id="cutscene-text-box"></div>
        <div class="cutscene-controls">
            <button id="cutscene-prev" class="cutscene-btn" onclick="prevCutscene()">ì´ì „</button>
            <button id="cutscene-next" class="cutscene-btn" onclick="nextCutscene()">ë‹¤ìŒ</button>
            <button class="cutscene-btn skip-btn" onclick="skipCutscene()">ìŠ¤í† ë¦¬ ìŠ¤í‚µ</button>
        </div>
    </div>

    <div id="chapter-overlay">
        <svg class="chapter-bulb-icon" viewBox="0 0 24 24">
            <path
                d="M12,2A7,7,0,0,0,5,9c0,2.38,1.19,4.47,3,5.74V17a1,1,0,0,0,1,1h6a1,1,0,0,0,1-1V14.74c1.81-1.27,3-3.36,3-5.74A7,7,0,0,0,12,2Zm2,14H10V14.15l1-0.7c1.33-0.93,1.33-0.93,1.33-2.45h1.34c0,1.52,0,1.52,1.33,2.45l1,0.7V16ZM11.33,9h1.34V12H11.33V9ZM15,19H9v1a1,1,0,0,0,1,1h4a1,1,0,0,0,1-1V19Z" />
        </svg>
        <h1 id="chapter-main-text">CHAPTER 1</h1>
        <div id="chapter-sub-text">ëª¨ë“  ê²ƒì˜ ì‹œì‘</div>
    </div>

    <div class="header">
        <div id="bit-container" class="bits-count">ë¹„íŠ¸: <span id="bits">0</span></div>
        <div style="text-align: right;">
            [ ì‹œìŠ¤í…œ ì˜¨ë¼ì¸ ]<br>
            ì‚¬ì´í´: <span id="cycle-speed">1000</span>ms
        </div>
    </div>

    <div class="tab-nav">
        <div class="tab-btn active" onclick="switchTab('main')">ë©”ì¸ ì‹œìŠ¤í…œ</div>
        <div class="tab-btn" onclick="switchTab('stats')">í•µì‹¬ í†µê³„</div>
        <div class="tab-btn" onclick="switchTab('settings')">ì„¤ì •</div>
    </div>

    <div id="tab-main" class="tab-content active">
        <div class="panel-container">
            <div class="section-header">
                <h3 style="color: var(--neon); margin:0;">í•˜ë“œì›¨ì–´ ì œì–´</h3>
                <button class="help-btn">? <span class="tooltip">ì „êµ¬ëŠ” ë§¤ ì‚¬ì´í´ë§ˆë‹¤ 50% í™•ë¥ ë¡œ ì¼œì§€ë©° ì •ë³´ë¥¼ ìƒì‚°í•©ë‹ˆë‹¤.</span></button>
            </div>

            <div id="hw-controls">
                <!-- í–‰ í™•ì¥ (Rows) -->
                <div id="btn-group-rows" class="hidden">
                    <div class="hw-btn-container" style="display: flex; gap: 5px; margin-bottom: 12px;">
                        <button id="btn-rows" class="action-btn" onclick="buyHW('rows')" style="flex: 1; margin: 0;">
                            <span class="rank-title">í–‰ í™•ì¥ (Rows)</span>
                            <span id="c-rows" class="cost-text">ë¹„ìš©: 50</span>
                            <span id="eff-rows" class="effect-info">í–‰: 1 -> 2 (ìµœëŒ€ 4)</span>
                        </button>
                        <button id="btn-rows-max" class="action-btn max-btn hidden" onclick="buyHWMax('rows')"
                            style="width: 80px; margin: 0; font-size: 11px; display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.2;">
                            <span class="max-count">Max +0</span>
                            <span class="max-cost" style="color: #aaa;">0</span>
                        </button>
                    </div>
                </div>

                <!-- í´ëŸ­ ê°€ì† (Speed) -->
                <div id="btn-group-speed" class="hidden">
                    <div class="hw-btn-container" style="display: flex; gap: 5px; margin-bottom: 12px;">
                        <button id="btn-speed" class="action-btn" onclick="buyHW('speed')" style="flex: 1; margin: 0;">
                            <span class="rank-title">í´ëŸ­ ê°€ì† (Overclock)</span>
                            <span id="c-speed" class="cost-text">ë¹„ìš©: 10</span>
                            <span id="eff-speed" class="effect-info">ì§€ì—°ì‹œê°„: 1000ms -> 900ms</span>
                        </button>
                        <button id="btn-speed-max" class="action-btn max-btn hidden" onclick="buyHWMax('speed')"
                            style="width: 80px; margin: 0; font-size: 11px; display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.2;">
                            <span class="max-count">Max +0</span>
                            <span class="max-cost" style="color: #aaa;">0</span>
                        </button>
                    </div>
                </div>

                <!-- ì—´ í™•ì¥ (Cols) -->
                <div id="btn-group-cols" class="hidden">
                    <div class="hw-btn-container" style="display: flex; gap: 5px; margin-bottom: 12px;">
                        <button id="btn-cols" class="action-btn" onclick="buyHW('cols')" style="flex: 1; margin: 0;">
                            <span class="rank-title">ì—´ í™•ì¥ (Cols)</span>
                            <span id="c-cols" class="cost-text">ë¹„ìš©: 5</span>
                            <span id="eff-cols" class="effect-info">ì—´: 1 -> 2 (ìµœëŒ€ 4)</span>
                        </button>
                        <button id="btn-cols-max" class="action-btn max-btn hidden" onclick="buyHWMax('cols')"
                            style="width: 80px; margin: 0; font-size: 11px; display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.2;">
                            <span class="max-count">Max +0</span>
                            <span class="max-cost" style="color: #aaa;">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="section-header">
                <h3 style="color: var(--neon); margin:0;">ì¸ì§€ ë‹¨ê³„</h3>
                <button class="help-btn">? <span class="tooltip">ìƒìœ„ ë‹¨ê³„ ì§„ì… ì‹œ í•˜ìœ„ ë‹¨ê³„ ìì›ì„ ì†Œëª¨í•©ë‹ˆë‹¤.</span></button>
            </div>

            <div id="rank-controls">
                <button id="btn-spark" class="action-btn" onclick="rankUp('spark')">
                    <span class="rank-title">ë°œìƒ Lv.<span id="lv-spark">0</span></span>
                    <span id="c-spark" class="cost-text">ë¹„ìš©: 5 ë¹„íŠ¸</span>
                    <div id="ms-spark" class="milestones"></div>
                </button>
                <button id="btn-impulse" class="action-btn hidden" onclick="rankUp('impulse')">
                    <span class="rank-title">ì¶©ë™ Lv.<span id="lv-impulse">0</span></span>
                    <span id="c-impulse" class="cost-text">í•„ìš”: ë°œìƒ Lv.4</span>
                    <div id="ms-impulse" class="milestones"></div>
                </button>
            </div>
        </div>
    </div>

    <div id="circuit-area">
        <h3 style="color: #666; font-size: 14px; margin: 0 0 10px 0;">í™œì„± íšŒë¡œ ë§µ</h3>
        <div id="bulb-grid" style="color: #444; font-size: 12px;">ì´ˆê¸°í™” ì¤‘...</div>
    </div>
    </div>

    <div id="tab-stats" class="tab-content container">
        <div class="panel" style="grid-column: span 2;">
            <div class="section-header">
                <h3 style="color: var(--neon); margin:0;">íš¨ê³¼ ë””ë ‰í† ë¦¬</h3>
            </div>
            <div class="sub-tab-nav">
                <button class="sub-tab-btn active" onclick="switchSubTab('spark')">ë°œìƒ</button>
                <button class="sub-tab-btn" onclick="switchSubTab('impulse')">ì¶©ë™</button>
                <button class="sub-tab-btn" onclick="switchSubTab('system')">ì‹œìŠ¤í…œ</button>
            </div>
            <div id="stats-list"></div>
        </div>
    </div>

    <div id="tab-settings" class="tab-content container">
        <div class="panel" style="grid-column: span 2;">
            <div class="setting-group">
                <div class="setting-title">ë°ì´í„° ê´€ë¦¬</div>
                <button class="setting-btn" onclick="saveGame(true)">ê°•ì œ ì €ì¥</button>
                <button class="setting-btn" onclick="resetGame()" style="color: #f88; border-color: #522;">ì „ì²´
                    ì´ˆê¸°í™”</button>
                <button class="setting-btn" style="margin-top: 10px;" onclick="showCutscene('intro')">ìŠ¤í† ë¦¬ ë‹¤ì‹œ ë³´ê¸°</button>
            </div>
        </div>
    </div>

    <div class="log" id="game-log">> ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ.</div>

    <script>
        let bits = new Decimal(0);
        let hardware = { rows: 1, cols: 1, speed: 0, prob: 0 };
        let ranks = { spark: 0, impulse: 0 };
        let maxSpark = 0; // ìµœê³  ë‹¬ì„± ë°œìƒ ë ˆë²¨
        let rankData = null; // JSONì—ì„œ ë¡œë“œë¨
        let activeSubTab = 'spark';

        // ìŠ¤í† ë¦¬ ì»·ì‹  ë°ì´í„°
        const storyData = {
            intro: [
                { img: 'assets/images/cutscenes/1-1-NW.png', text: 'ì¡¸ì—…ì¥ì€ ëƒ„ë¹„ ë°›ì¹¨ìœ¼ë¡œ ì“´ ì§€ ì˜¤ë˜ë‹¤. ë©ì²­í•œ ìƒì‚¬, ì˜ë¯¸ ì—†ëŠ” íšŒì˜... ê·¸ëŸ° ê±´ ë‚´ ì•Œ ë°” ì•„ë‹ˆë‹¤. ë‚˜ì—ê² ì´ ê³ ì² ë“¤ì´ ë” ëŒ€í•˜ê¸° í¸í•˜ë‹ˆê¹Œ.' },
                { img: 'assets/images/cutscenes/1-2-NW.png', text: 'í•˜ì§€ë§Œ ì²œì¬ë„ ë°¥ì€ ë¨¹ì–´ì•¼ í•œë‹¤. ì›”ì„¸ ë‚¼ ë‚ ì§œëŠ” ë‹¤ê°€ì˜¤ê³ , ë‚¨ì€ ê±´ ì°½ê³  ê°€ë“í•œ ì¬ê³  ë¶€í’ˆë“¤ ë¿.' },
                { img: 'assets/images/cutscenes/1-3-NW.png', text: 'íŒ”ì•„ì„œ ëˆì„ ë§Œë“¤ ìˆ˜ ì—†ë‹¤ë©´, ë§Œë“¤ì–´ì„œ ëˆì„ ë²Œê²Œ í•˜ë©´ ëœë‹¤. ê¸°ì¡´ì˜ ì»´í“¨í„° êµ¬ì¡°ëŠ” ë„ˆë¬´ ë¹„íš¨ìœ¨ì ì´ì•¼. ë‚´ê°€ ì§ì ‘ ì„¤ê³„í•œë‹¤. ì´ë¡ ìƒ ì™„ë²½í•œ, ë¬´í•œ ì—°ì‚°ê¸°ë¥¼.' },
                { img: 'assets/images/cutscenes/1-4-NW.png', text: 'ì‹œìŠ¤í…œ ê°€ë™. ...ì‹œì‘í•´ ë³¼ê¹Œ?' }
            ]
        };

        let currentStory = null;
        let currentCutsceneIndex = 0;
        let isGamePaused = false;

        window.showCutscene = function (storyId) {
            currentStory = storyData[storyId];
            if (!currentStory) return;

            currentCutsceneIndex = 0;
            isGamePaused = true;
            document.getElementById('cutscene-overlay').classList.remove('hidden');
            updateCutsceneUI();
        }

        function updateCutsceneUI() {
            const scene = currentStory[currentCutsceneIndex];
            document.getElementById('cutscene-image').src = scene.img;
            document.getElementById('cutscene-text-box').innerText = scene.text;

            document.getElementById('cutscene-prev').disabled = (currentCutsceneIndex === 0);
            document.getElementById('cutscene-next').innerText = (currentCutsceneIndex === currentStory.length - 1) ? "ì‹œì‘í•˜ê¸°" : "ë‹¤ìŒ";
        }

        window.nextCutscene = function () {
            if (currentCutsceneIndex < currentStory.length - 1) {
                currentCutsceneIndex++;
                updateCutsceneUI();
            } else {
                skipCutscene();
            }
        }

        window.prevCutscene = function () {
            if (currentCutsceneIndex > 0) {
                currentCutsceneIndex--;
                updateCutsceneUI();
            }
        }

        window.skipCutscene = function () {
            document.getElementById('cutscene-overlay').classList.add('hidden');
            playChapterAnimation();
        }

        window.playChapterAnimation = function () {
            const overlay = document.getElementById('chapter-overlay');
            const bulb = overlay.querySelector('.chapter-bulb-icon');
            const mainText = document.getElementById('chapter-main-text');
            const subText = document.getElementById('chapter-sub-text');

            overlay.classList.add('active');
            bulb.classList.add('animate');
            mainText.classList.add('animate');
            subText.classList.add('animate');

            setTimeout(() => {
                overlay.classList.remove('active');
                // ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì œê±° (ë‚˜ì¤‘ì— ë‹¤ì‹œ ë³¼ ë•Œë¥¼ ìœ„í•´)
                setTimeout(() => {
                    bulb.classList.remove('animate');
                    mainText.classList.remove('animate');
                    subText.classList.remove('animate');

                    isGamePaused = false;
                    if (!gameLoopStarted) {
                        gameLoopStarted = true;
                        gameLoop();
                    }
                    saveGame();
                }, 1000);
            }, 5000); // 5ì´ˆ ë™ì•ˆ ë…¸ì¶œ
        }

        function format(value, places = 3) {
            let d = new Decimal(value);
            if (d.lt(1e6)) {
                return d.floor().toString();
            }
            return d.toExponential(places).replace("+", "");
        }

        // rankData.json íŒŒì¼ì—ì„œ cognitive step ë°ì´í„° ë¡œë“œ
        async function loadRankData() {
            try {
                // í˜„ì¬ í˜ì´ì§€ì˜ ê²½ë¡œë¥¼ ê¸°ì¤€ìœ¼ë¡œ rankData.json ê²½ë¡œ ì„¤ì •
                const jsonPath = new URL('rankData.json', window.location.href).href;
                const response = await fetch(jsonPath);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                rankData = data;
                console.log('rankData ë¡œë“œ ì„±ê³µ:', rankData);
                return true;
            } catch (error) {
                console.error('rankData ë¡œë“œ ì‹¤íŒ¨:', error);
                console.error('ì‹œë„í•œ ê²½ë¡œ:', new URL('rankData.json', window.location.href).href);
                alert(`ê²Œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì—ëŸ¬: ${error.message}\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.`);
                return false;
            }
        }

        function saveGame(notify = false) {
            const saveObj = { bits: bits.toString(), hardware: hardware, ranks: ranks, maxSpark: maxSpark };
            localStorage.setItem('infCompSave', JSON.stringify(saveObj));
            if (notify) alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function loadGame() {
            const saveStr = localStorage.getItem('infCompSave');
            if (saveStr) {
                try {
                    const saveObj = JSON.parse(saveStr);
                    bits = new Decimal(saveObj.bits);
                    hardware = saveObj.hardware;
                    ranks = saveObj.ranks;
                    // í˜¸í™˜ì„±ì„ ìœ„í•œ ì˜ˆì™¸ ì²˜ë¦¬ (ì´ì „ ë²„ì „ì—ì„œ impulse/intuitionì´ì—ˆì„ ê²½ìš°)
                    if (saveObj.ranks.impulse !== undefined && saveObj.ranks.spark === undefined) {
                        ranks.spark = saveObj.ranks.impulse;
                        ranks.impulse = saveObj.ranks.intuition || 0;
                    }
                    maxSpark = saveObj.maxSpark || ranks.spark || 0;
                    // ì „ì•• ìµœì í™”(prob) ëˆ„ë½ ì‹œ ì´ˆê¸°í™” (ê¸°ì¡´ í”Œë ˆì´ì–´ í˜¸í™˜ì„±)
                    if (hardware.prob === undefined) hardware.prob = 0;
                    addLog("ë°ì´í„° ë¡œë“œ ì™„ë£Œ.");
                } catch (e) { }
            }
        }

        window.resetGame = function () {
            if (confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('infCompSave');
                // ì´ˆê¸°í™” í›„ ì»·ì‹ ë¶€í„° ë³´ì—¬ì£¼ê¸° ìœ„í•´ ìƒˆë¡œê³ ì¹¨ ëŒ€ì‹  ì´ˆê¸° ìƒíƒœë¡œ ëŒë¦¼
                bits = new Decimal(0);
                hardware = { rows: 1, cols: 1, speed: 0, prob: 0 };
                ranks = { spark: 0, impulse: 0 };
                maxSpark = 0;
                localStorage.setItem('infCompFirstTime', 'true');
                showCutscene('intro');
                initGrid();
                updateUI();
            }
        }

        // ìµœëŒ€ ê°€ë¡œ í¬ê¸° ê³„ì‚° (ê¸°ë³¸ 4, ë°œìƒ 5+ ë ˆë²¨ë§ˆë‹¤ +1)
        function getMaxCols() {
            let baseMax = 4;
            if (ranks.spark >= 7) {
                return Math.min(baseMax + (ranks.spark - 6), 8);
            }
            return baseMax;
        }

        const getHWCost = (type) => {
            let base = { rows: 50, cols: 5, speed: 10 }[type];
            let exp = { rows: 3.5, cols: 2.5, speed: 1.6 }[type];
            let lv = type === 'speed' ? hardware.speed : (type === 'rows' ? hardware.rows - 1 : hardware.cols - 1);

            // í•˜ë“œì›¨ì–´ ë¹„ìš© ìŠ¤ì¼€ì¼ë§ ê°ì†Œ (ì¶©ë™ 1ë ˆë²¨)
            if (ranks.impulse >= 1) exp = 1 + (exp - 1) * 0.8;

            // í–‰(rows) ìŠ¤ì¼€ì¼ë§ ê°€ì† (Level 1ë¶€í„° ì ìš©)
            if (type === 'rows') {
                let currentLevel = hardware.rows - 1;
                // Level 1: adj=0 (Cost 50), Level 2: adj=2 (Cost 612), Level 3: adj=4.8 (Cost 21k)
                let adjustedExp = currentLevel + Math.pow(currentLevel, 1.5);
                return new Decimal(base).times(Decimal.pow(exp, adjustedExp)).floor();
            }

            // ê°€ë¡œ(cols) ë ˆë²¨ 5 ì´ìƒìœ¼ë¡œ ì˜¬ë¦´ ë•Œ ë¹„ìš© ì¦ê°€ìœ¨ ê°€ì†
            if (type === 'cols' && hardware.cols >= 5) {
                let currentLevel = hardware.cols - 1;
                // Level 5: adj=5 (Cost 488), Level 6: adj=7.8 (Cost 6.4k)
                let adjustedExp = currentLevel + Math.pow(currentLevel - 3, 1.5);
                return new Decimal(base).times(Decimal.pow(exp, adjustedExp)).floor();
            }


            return new Decimal(base).times(Decimal.pow(exp, lv)).floor();
        };

        const getRankCost = (id) => {
            if (id === 'impulse') return 0; // í•„ìš” Spark ë ˆë²¨ë¡œ ê³„ì‚°ë¨
            if (id === 'spark') {
                let scalingMult = 1.0;
                // ë°œìƒ ë¹„ìš© ìŠ¤ì¼€ì¼ë§ ê°ì†Œ (ì¶©ë™ 1ë ˆë²¨)
                if (ranks.impulse >= 1) scalingMult = 0.8;
                let exponent = Math.pow(ranks.spark, 1 + (1 / 6) * scalingMult);
                let baseCost = Decimal.pow(2.5, exponent).times(5);

                return baseCost.floor();
            }
            return new Decimal(rankData[id].baseCost).times(Decimal.pow(rankData[id].scale, ranks[id])).floor();
        }

        window.switchTab = function (tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const tabMap = { 'main': 0, 'stats': 1, 'settings': 2 };
            document.querySelectorAll('.tab-btn')[tabMap[tabName]].classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            if (tabName === 'stats') renderStats();
        }

        window.switchSubTab = function (subTabId) {
            activeSubTab = subTabId;
            document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                if (btn.innerText === (subTabId === 'spark' ? 'ë°œìƒ' : (subTabId === 'impulse' ? 'ì¶©ë™' : 'ì‹œìŠ¤í…œ'))) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            renderStats();
        }

        window.buyHW = function (type) {
            // ìµœëŒ€ êµ¬ë§¤ ëª¨ë“œ í™•ì¸
            const isMax = document.getElementById('buy-max-toggle').checked;

            // ì„¸ë¡œ ìµœëŒ€ì¹˜: 4 (ë°œìƒ 10 ì´ìƒì´ë©´ +2?) - ì¼ë‹¨ 4ë¡œ ê³ ì •
            let maxRows = 4;
            if (type === 'rows' && hardware.rows >= maxRows) return;

            // ê°€ë¡œ ìµœëŒ€ì¹˜: ê¸°ë³¸ 4, ë°œìƒ 5+ ë ˆë²¨ë§ˆë‹¤ +1
            if (type === 'cols' && hardware.cols >= getMaxCols()) return;

            if (isMax) {
                // ìµœëŒ€ êµ¬ë§¤ ë¡œì§
                let bought = 0;
                while (true) {
                    if (type === 'rows' && hardware.rows >= maxRows) break;
                    if (type === 'cols' && hardware.cols >= getMaxCols()) break;

                    let cost = getHWCost(type);
                    if (bits.gte(cost)) {
                        bits = bits.minus(cost);
                        hardware[type]++;
                        bought++;
                    } else {
                        break;
                    }
                    if (bought >= 100) break; // ì•ˆì „ì¥ì¹˜
                }
                if (bought > 0) {
                    if (type === 'rows' || type === 'cols') initGrid();
                    updateUI();
                    saveGame();
                }
            } else {
                // ë‹¨ì¼ êµ¬ë§¤ ë¡œì§
                let cost = getHWCost(type);
                if (bits.gte(cost)) {
                    bits = bits.minus(cost);
                    hardware[type]++;
                    if (type === 'rows' || type === 'cols') initGrid();
                    updateUI();
                    saveGame();
                }
            }
        }

        window.rankUp = function (id) {
            if (id === 'spark') {
                let cost = getRankCost(id);
                if (bits.lt(cost)) return;

                bits = new Decimal(0);
                ranks.spark++;
                maxSpark = Math.max(maxSpark, ranks.spark);
                hardware = { rows: 1, cols: 1, speed: 0, prob: 0 };
                addLog(`ë°œìƒ Lv.${ranks.spark}: ì‚¬ê³  í™•ì¥.`);
            }
            else if (id === 'impulse') {
                let req = Math.pow(ranks.impulse + 2, 2);
                if (ranks.spark < req) return;

                ranks.impulse++;
                ranks.spark = 0;
                bits = new Decimal(0);
                hardware = { rows: 1, cols: 1, speed: 0, prob: 0 };
                addLog(`ì¶©ë™ Lv.${ranks.impulse}: ì¶©ë™ ë‹¨ê³„ ìŠ¹ê¸‰.`);
            }
            initGrid();
            updateUI();
            saveGame();
        }

        function calculateDelay(speedLevel) {
            let delay = 1000;
            for (let i = 0; i < speedLevel; i++) {
                if (i < 12) {
                    delay *= 0.87;
                } else {
                    delay *= 0.93;
                }
            }
            return delay;
        }

        function gameLoop() {
            if (isGamePaused) {
                setTimeout(gameLoop, 100);
                return;
            }
            let delay = calculateDelay(hardware.speed);
            // ìµœì†Œ ë”œë ˆì´ ì œí•œ: ë¸Œë¼ìš°ì € íƒ€ì´ë¨¸ í•´ìƒë„ì™€ ì„±ëŠ¥ì„ ê³ ë ¤í•˜ì—¬ 16ms (ì•½ 60fps)ë¡œ ì œí•œ
            // 4ms ë¯¸ë§Œì´ë©´ ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ ì˜¬ë¦¬ì§€ë§Œ, UI ì—…ë°ì´íŠ¸ ë¹ˆë„ë¥¼ ê³ ë ¤í•´ 16msê°€ ì ì ˆ
            delay = Math.max(delay, 16);
            processTick();
            updateUI();
            document.getElementById('cycle-speed').innerText = Math.floor(delay);
            setTimeout(gameLoop, delay);
        }

        function processTick() {
            let prob = 50;

            let onCount = 0;
            let total = hardware.rows * hardware.cols;
            for (let i = 0; i < total; i++) {
                if (Math.random() * 100 < prob) { onCount++; flash(i); }
            }

            if (onCount > 0) {
                let formulaBonus = new Decimal(1);

                // ë°œìƒ 5ë ˆë²¨ ë³´ë„ˆìŠ¤
                if (ranks.spark >= 5) {
                    let sBonus = ranks.spark * 0.5 + 1;
                    // ì¶©ë™ 2ë ˆë²¨: ë°œìƒ ë³´ë„ˆìŠ¤ ì œê³±
                    if (ranks.impulse >= 2) {
                        sBonus = sBonus ** 2;
                    }
                    formulaBonus = formulaBonus.times(sBonus);
                }

                // ì¶©ë™ 2ë ˆë²¨: ì¶©ë™ ë¹„ë¡€ ë³´ë„ˆìŠ¤ (ë…ë¦½ ì ìš©)
                if (ranks.impulse >= 2) {
                    let iBonus = ranks.impulse * 2 + 1;
                    formulaBonus = formulaBonus.times(iBonus);
                }

                let yieldMult = formulaBonus;

                let comboMult = new Decimal(1);
                // ë°œìƒ 6ë ˆë²¨ ì½¤ë³´ í•´ê¸ˆ
                if (ranks.spark >= 6) {
                    let threshold = Math.ceil((hardware.rows * hardware.cols) / 2);
                    if (onCount > threshold) {
                        let bonusRaw = 1 + 1.2 ** (onCount - threshold);
                        if (bonusRaw > 100) {
                            bonusRaw = 100 + Math.pow(bonusRaw - 100, 0.5);
                        }
                        comboMult = new Decimal(bonusRaw);
                    }
                }

                bits = bits.plus(yieldMult.times(onCount).times(comboMult));
            }
        }

        function updateUI() {
            document.getElementById('bits').innerText = format(bits.floor());
            document.getElementById('lv-spark').innerText = ranks.spark;
            document.getElementById('lv-impulse').innerText = ranks.impulse;

            updateBtn('btn-spark', getRankCost('spark'), '');

            const impBtn = document.getElementById('btn-impulse');
            let reqSpark = Math.pow(ranks.impulse + 2, 2);
            // ì¶©ë™ 1ë ˆë²¨ì€ ìˆ˜ì¹˜ê°€ ì•„ë‹ˆë¼ ë°œìƒì˜ ì—…ê·¸ë ˆì´ë“œ ë¹„ìš©ì„ ê°ì†Œì‹œí‚´ (UI í‘œì‹œì—ì„œëŠ” ê·¸ëŒ€ë¡œ)

            impBtn.querySelector('.cost-text').innerText = `í•„ìš”: ë°œìƒ Lv.${reqSpark}`;
            if (ranks.spark >= reqSpark) impBtn.classList.add('affordable');
            else impBtn.classList.remove('affordable');
            impBtn.disabled = ranks.spark < reqSpark;

            // í•˜ë“œì›¨ì–´ ë²„íŠ¼ í•´ê¸ˆ ì¡°ê±´ ë³€ê²½
            // ì—´ í™•ì¥(cols)ì€ ë°œìƒ 1 ì´ìƒ
            if (ranks.spark >= 1) document.getElementById('btn-cols').classList.remove('hidden');
            else document.getElementById('btn-cols').classList.add('hidden');

            // ìµœëŒ€ êµ¬ë§¤ ë²„íŠ¼ í‘œì‹œ (ìµœê³  ë ˆë²¨ 10 ì´ìƒ)
            if (maxSpark >= 10) document.getElementById('buy-max-container').classList.remove('hidden');
            else {
                document.getElementById('buy-max-container').classList.add('hidden');
                document.getElementById('buy-max-toggle').checked = false; // ìˆ¨ê²¨ì§ˆ ë•Œ ì²´í¬ í•´ì œ
            }

            // í´ëŸ­ ê°€ì†ì€ ë°œìƒ 2 ì´ìƒ
            if (ranks.spark >= 2) document.getElementById('btn-speed').classList.remove('hidden');
            else document.getElementById('btn-speed').classList.add('hidden');

            // í–‰ í™•ì¥(rows)ì€ ë°œìƒ 3 ì´ìƒ (ê¸°ì¡´ ë°œìƒ 4)
            if (ranks.spark >= 3) document.getElementById('btn-rows').classList.remove('hidden');
            else document.getElementById('btn-rows').classList.add('hidden');


            // ì¶©ë™ ë²„íŠ¼: ë°œìƒ 4 ì´ìƒì´ê±°ë‚˜, ì´ë¯¸ ì¶©ë™ì„ í•œ ë²ˆì´ë¼ë„ ì˜¬ë ¸ë‹¤ë©´ í‘œì‹œ
            if (ranks.spark >= 4 || ranks.impulse > 0) document.getElementById('btn-impulse').classList.remove('hidden');
            else document.getElementById('btn-impulse').classList.add('hidden');

            updateHWBtn('btn-rows', 'rows');
            updateHWBtn('btn-cols', 'cols');

            updateBtn('btn-speed', getHWCost('speed'), `ì§€ì—°ì‹œê°„: ${Math.floor(calculateDelay(hardware.speed))}ms -> ${Math.floor(calculateDelay(hardware.speed + 1))}ms`);

            if (bits.gte(10)) document.getElementById('bit-container').classList.add('affordable');
            else document.getElementById('bit-container').classList.remove('affordable');

            updateMilestones('spark');
            updateMilestones('impulse');
        }

        function updateHWBtn(id, type) {
            const btn = document.getElementById(id);
            let maxVal = type === 'cols' ? getMaxCols() : 4;

            if (hardware[type] >= maxVal) {
                btn.querySelector('.rank-title').innerText = type === 'cols' ? "ì—´ í™•ì¥ (ìµœëŒ€)" : "í–‰ í™•ì¥ (ìµœëŒ€)";
                btn.querySelector('.cost-text').innerText = "ìµœëŒ€";
                btn.querySelector('.effect-info').innerText = "ì œí•œ ë„ë‹¬";
                btn.classList.remove('affordable');
                btn.disabled = true;
            } else {
                updateBtn(id, getHWCost(type), `${type === 'rows' ? 'í–‰' : 'ì—´'}: ${hardware[type]} -> ${hardware[type] + 1} (ìµœëŒ€ ${maxVal})`);
            }
        }

        function updateBtn(id, cost, effectText) {
            const btn = document.getElementById(id);
            if (!btn || (btn.disabled && cost === 'MAX')) return;

            const costEl = btn.querySelector('.cost-text');
            const effEl = btn.querySelector('.effect-info');
            if (costEl) costEl.innerText = `ë¹„ìš©: ${format(cost)}`;
            if (effEl) effEl.innerText = effectText;

            if (bits.gte(cost)) btn.classList.add('affordable');
            else btn.classList.remove('affordable');
            btn.disabled = bits.lt(cost);
        }

        function updateMilestones(id) {
            const msContainer = document.getElementById(`ms-${id}`);
            const data = rankData[id].ms;
            const curLv = ranks[id];
            let active = data.filter(m => m.lv <= curLv).pop();

            // ë¯¸ë˜ ë§ˆì¼ìŠ¤í†¤ í•„í„°ë§: spoilerMin í•„ë“œ ê¸°ë°˜
            let future = data.filter(m => {
                if (m.lv <= curLv) return false;
                if (m.spoilerMin && curLv < m.spoilerMin) return false;
                return true;
            }).slice(0, active ? 2 : 3);

            let html = '';
            if (active) html += `<div class="ms-item ms-active">âœ” Lv.${active.lv}: ${active.desc}</div>`;
            future.forEach(m => {
                let desc = m.desc;
                // ìŠ¤í¬ì¼ëŸ¬ ë§ˆìŠ¤í‚¹: í•œ ë²ˆë„ ë„ë‹¬í•œ ì  ì—†ìœ¼ë©´ ??? ì²˜ë¦¬ (spoilerMinì´ ìˆëŠ” ê²½ìš°)
                // ë°œìƒ 12ë ˆë²¨ ë“±
                if (m.spoilerMin && maxSpark < m.lv) {
                    desc = "???";
                }
                html += `<div class="ms-item ms-future">ğŸ”’ Lv.${m.lv}: ${desc}</div>`;
            });
            msContainer.innerHTML = html;
        }

        function renderStats() {
            const list = document.getElementById('stats-list');
            let html = '';

            if (activeSubTab === 'spark' || activeSubTab === 'impulse') {
                const type = activeSubTab;
                const curLv = ranks[type];
                if (curLv > 0) {
                    const activeMs = rankData[type].ms.filter(m => m.lv <= curLv);
                    activeMs.forEach(m => {
                        let desc = m.desc;
                        let detailText = m.detail || '';

                        // Dynamic descriptions
                        if (type === 'spark' && m.lv === 5) {
                            let sBonus = ranks.spark * 0.5 + 1;
                            if (ranks.impulse >= 2) sBonus = sBonus ** 2;
                            detailText += `<br><br><b>í˜„ì¬ ë³´ë„ˆìŠ¤:</b> x${format(sBonus, 3)}`;
                        }
                        if (type === 'impulse' && m.lv === 2) {
                            let iBonus = ranks.impulse * 2 + 1;
                            detailText += `<br><br><b>í˜„ì¬ ë³´ë„ˆìŠ¤:</b> x${format(iBonus, 3)}`;
                        }

                        const helpBtn = detailText ? `<button class="help-btn">? <span class="tooltip">${detailText}</span></button>` : '';
                        html += `<div class="stat-line"><span class="stat-label">[Lv.${m.lv}]</span>${helpBtn} ${desc}</div>`;
                    });
                }
            } else if (activeSubTab === 'system') {
                // System/General stats
                let sBonus = 1;
                let iBonus = 1;
                let hasBonus = false;

                if (ranks.spark >= 5) {
                    sBonus = ranks.spark * 0.5 + 1;
                    if (ranks.impulse >= 2) sBonus = sBonus ** 2;
                    hasBonus = true;
                }

                if (ranks.impulse >= 2) {
                    iBonus = ranks.impulse * 2 + 1;
                    hasBonus = true;
                }

                if (hasBonus) {
                    let total = sBonus * iBonus;
                    const bonusDetail = `ë°œìƒ ë³´ë„ˆìŠ¤(x${format(sBonus, 2)})ì™€ ì¶©ë™ ë³´ë„ˆìŠ¤(x${format(iBonus, 2)})ê°€ ê²°í•©ëœ ìµœì¢… ë°°ìœ¨ì…ë‹ˆë‹¤.`;
                    html += `<div class="stat-line"><span class="stat-label">[íš¨ê³¼]</span><button class="help-btn">? <span class="tooltip">${bonusDetail}</span></button> ìµœì¢… ìƒì‚°ëŸ‰ ë³´ë„ˆìŠ¤: x${format(total, 3)}</div>`;
                }
                if (ranks.spark >= 6) {
                    let threshold = Math.ceil((hardware.rows * hardware.cols) / 2);
                    const comboDetail = `ì „êµ¬ ê°œìˆ˜ì˜ 50%(${threshold}ê°œ) ì´ìƒì´ ì¼œì§ˆ ë•Œë¶€í„° ì§€ìˆ˜ì  ì½¤ë³´ ë³´ë„ˆìŠ¤ê°€ ë°œìƒí•©ë‹ˆë‹¤.`;
                    html += `<div class="stat-line"><span class="stat-label">[íš¨ê³¼]</span><button class="help-btn">? <span class="tooltip">${comboDetail}</span></button> ì½¤ë³´ ì‹œë„ˆì§€ ì„ê³„ì¹˜: ${threshold}ê°œ</div>`;
                }
            }

            if (html === '') html = '<div style="padding:10px; color:#666;">í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— í™œì„±í™”ëœ íš¨ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            list.innerHTML = html;
        }

        function initGrid() {
            const grid = document.getElementById('bulb-grid');
            if (!grid) return;
            grid.style.gridTemplateColumns = `repeat(${hardware.cols}, 1fr)`;
            grid.innerHTML = '';
            for (let i = 0; i < hardware.rows * hardware.cols; i++) {
                let b = document.createElement('div'); b.className = 'bulb'; b.id = `bulb-${i}`;
                grid.appendChild(b);
            }
        }

        function flash(id) {
            const el = document.getElementById(`bulb-${id}`);
            if (el) { el.classList.add('on'); setTimeout(() => el.classList.remove('on'), 100); }
        }

        function addLog(msg) {
            const log = document.getElementById('game-log');
            log.innerHTML = `> ${msg}<br>${log.innerHTML}`;
        }

        // ìë™ ì €ì¥ (1ë¶„ë§ˆë‹¤)
        setInterval(() => {
            if (!isGamePaused) saveGame();
        }, 60000);

        let gameLoopStarted = false;

        // ê²Œì„ ì´ˆê¸°í™”: rankData ë¡œë“œ í›„ ê²Œì„ ì‹œì‘
        window.onload = async () => {
            const loaded = await loadRankData();
            if (loaded) {
                loadGame();
                initGrid();

                // ìµœì´ˆ ì‹¤í–‰ ë˜ëŠ” ê°•ì œ ì»·ì‹  ì¡°ê±´ ì²´í¬
                const isFirstTime = localStorage.getItem('infCompFirstTime') !== 'false';
                if (isFirstTime) {
                    localStorage.setItem('infCompFirstTime', 'false');
                    showCutscene('intro');
                } else {
                    gameLoopStarted = true;
                    gameLoop();
                }
            }
        };
    </script>
</body>

</html>