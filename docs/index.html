<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Computation-Incremental</title>
    <script src="https://cdn.jsdelivr.net/npm/break_eternity.js"></script>
    <style>
        :root {
            --neon: #00ff41;
            --bg: #050505;
            --white: #eee;
            --gray: #444;
            --panel-bg: #0a0a0a;
        }

        body {
            background: var(--bg);
            color: var(--white);
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tab-nav {
            width: 900px;
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            background: #111;
            border: 1px solid #333;
            color: #888;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: 0.2s;
        }

        .tab-btn:hover {
            background: #1a1a1a;
            color: #ccc;
        }

        .tab-btn.active {
            background: var(--panel-bg);
            border-color: var(--neon);
            color: var(--neon);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.1);
        }

        .tab-content {
            display: none;
            width: 900px;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header {
            width: 900px;
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #222;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .bits-count {
            font-size: 28px;
            transition: 0.3s;
        }

        .bits-count.affordable {
            color: var(--neon);
            text-shadow: 0 0 10px var(--neon);
        }

        /* íŒ¨ë„ ë ˆì´ì•„ì›ƒ ìˆ˜ì • */
        .panel-container {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 30px;
            width: 100%;
        }

        .panel {
            border: 1px solid #333;
            padding: 20px;
            background: var(--panel-bg);
            border-radius: 8px;
            min-height: 450px;
            position: relative;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .help-btn {
            background: none;
            border: 1px solid #333;
            color: #666;
            cursor: pointer;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            position: relative;
            vertical-align: middle;
            margin-left: 6px;
        }

        .help-btn .tooltip {
            visibility: hidden;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel-bg);
            border: 1px solid var(--neon);
            color: var(--white);
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 11px;
            z-index: 1000;
            pointer-events: none;
            display: block;
            width: auto;
            min-width: 200px;
            max-width: 400px;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            text-align: left;
            box-sizing: border-box;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .help-btn:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .help-btn:hover .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--neon);
            margin-bottom: -5px;
        }

        /* íšŒë¡œ ì˜ì—­ (ë¡œê·¸ ìœ„ë¡œ ì´ë™) */
        #circuit-area {
            width: 100%;
            background: var(--panel-bg);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 200px;
        }

        #bulb-grid {
            display: grid;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }

        .bulb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #1a1a1a;
            border: 2px solid #333;
            transition: background 0.05s, box-shadow 0.05s;
        }

        .bulb.on {
            background: #ffca28;
            border-color: #ffca28;
            box-shadow: 0 0 15px #ffca28, 0 0 5px #fff;
            z-index: 10;
        }

        button.action-btn {
            background: #111;
            color: var(--white);
            border: 1px solid var(--gray);
            padding: 12px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            text-align: left;
            border-radius: 4px;
            position: relative;
            transition: 0.2s;
        }

        button.action-btn:hover:not(:disabled) {
            border-color: var(--neon);
            background: #161616;
            transform: translateX(2px);
        }

        button.action-btn.affordable {
            color: var(--neon);
            border-color: var(--neon);
        }

        button.action-btn:disabled {
            opacity: 0.75;
            cursor: not-allowed;
        }

        .rank-title {
            font-size: 16px;
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
        }

        .cost-text {
            font-size: 13px;
            color: #aaa;
            position: absolute;
            top: 12px;
            right: 12px;
        }

        button.action-btn.affordable .cost-text {
            color: var(--neon);
        }

        .effect-info {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            display: block;
        }

        .milestones {
            border-top: 1px dashed #333;
            padding-top: 6px;
            margin-top: 8px;
            font-size: 11px;
        }

        .ms-item {
            margin-bottom: 2px;
        }

        .ms-active {
            color: var(--neon);
            font-weight: bold;
        }

        .ms-future {
            color: #555;
        }

        .log {
            height: 100px;
            overflow-y: hidden;
            border: 1px solid #222;
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            width: 900px;
            padding: 10px;
            background: #000;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        .stat-line {
            padding: 8px;
            border-bottom: 1px solid #222;
            font-size: 14px;
        }

        .stat-label {
            color: var(--neon);
            font-weight: bold;
            margin-right: 10px;
        }

        .setting-btn {
            background: #222;
            border: 1px solid #555;
            color: #eee;
            padding: 10px 20px;
            margin-bottom: 10px;
            cursor: pointer;
            width: 100%;
            text-align: left;
        }

        .setting-btn:hover {
            background: #333;
            border-color: #888;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-title {
            color: var(--neon);
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .sub-tab-nav {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid #222;
            padding-bottom: 10px;
        }

        .sub-tab-btn {
            background: #111;
            border: 1px solid #333;
            color: #666;
            padding: 5px 15px;
            cursor: pointer;
            font-size: 12px;
            border-radius: 4px;
            transition: 0.2s;
        }

        .sub-tab-btn:hover {
            color: #aaa;
            border-color: #555;
        }

        .sub-tab-btn.active {
            background: #222;
            color: var(--neon);
            border-color: var(--neon);
        }
    </style>
</head>

<body>

    <div class="header">
        <div id="bit-container" class="bits-count">ë¹„íŠ¸: <span id="bits">0</span></div>
        <div style="text-align: right;">
            [ ì‹œìŠ¤í…œ ì˜¨ë¼ì¸ ]<br>
            ì‚¬ì´í´: <span id="cycle-speed">1000</span>ms
        </div>
    </div>

    <div class="tab-nav">
        <div class="tab-btn active" onclick="switchTab('main')">ë©”ì¸ ì‹œìŠ¤í…œ</div>
        <div class="tab-btn" onclick="switchTab('stats')">í•µì‹¬ í†µê³„</div>
        <div class="tab-btn" onclick="switchTab('settings')">ì„¤ì •</div>
    </div>

    <div id="tab-main" class="tab-content active">
        <div class="panel-container">
            <div class="panel">
                <div class="section-header">
                    <h3 style="color: var(--neon); margin:0;">í•˜ë“œì›¨ì–´ ì œì–´</h3>
                    <button class="help-btn">? <span class="tooltip">ì „êµ¬ëŠ” ë§¤ ì‚¬ì´í´ë§ˆë‹¤ 50% í™•ë¥ ë¡œ ì¼œì§€ë©° ì •ë³´ë¥¼ ìƒì‚°í•©ë‹ˆë‹¤.</span></button>
                </div>

                <div id="hw-controls">
                    <button id="btn-rows" class="action-btn hidden" onclick="buyHW('rows')">
                        <span class="rank-title">í–‰ í™•ì¥ (Rows)</span>
                        <span id="c-rows" class="cost-text">ë¹„ìš©: 50</span>
                        <span id="eff-rows" class="effect-info">í–‰: 1 -> 2 (ìµœëŒ€ 4)</span>
                    </button>
                    <button id="btn-speed" class="action-btn hidden" onclick="buyHW('speed')">
                        <span class="rank-title">í´ëŸ­ ê°€ì† (Overclock)</span>
                        <span id="c-speed" class="cost-text">ë¹„ìš©: 10</span>
                        <span id="eff-speed" class="effect-info">ì§€ì—°ì‹œê°„: 1000ms -> 900ms</span>
                    </button>
                    <button id="btn-cols" class="action-btn hidden" onclick="buyHW('cols')">
                        <span class="rank-title">ì—´ í™•ì¥ (Cols)</span>
                        <span id="c-cols" class="cost-text">ë¹„ìš©: 5</span>
                        <span id="eff-cols" class="effect-info">ì—´: 1 -> 2 (ìµœëŒ€ 4)</span>
                    </button>
                </div>
            </div>

            <div class="panel">
                <div class="section-header">
                    <h3 style="color: var(--neon); margin:0;">ì¸ì§€ ë‹¨ê³„</h3>
                    <button class="help-btn">? <span class="tooltip">ìƒìœ„ ë‹¨ê³„ ì§„ì… ì‹œ í•˜ìœ„ ë‹¨ê³„ ìì›ì„ ì†Œëª¨í•©ë‹ˆë‹¤.</span></button>
                </div>

                <div id="rank-controls">
                    <button id="btn-spark" class="action-btn" onclick="rankUp('spark')">
                        <span class="rank-title">ë°œìƒ Lv.<span id="lv-spark">0</span></span>
                        <span id="c-spark" class="cost-text">ë¹„ìš©: 5 ë¹„íŠ¸</span>
                        <div id="ms-spark" class="milestones"></div>
                    </button>
                    <button id="btn-impulse" class="action-btn hidden" onclick="rankUp('impulse')">
                        <span class="rank-title">ì¶©ë™ Lv.<span id="lv-impulse">0</span></span>
                        <span id="c-impulse" class="cost-text">í•„ìš”: ë°œìƒ Lv.4</span>
                        <div id="ms-impulse" class="milestones"></div>
                    </button>
                </div>
            </div>
        </div>

        <div id="circuit-area">
            <h3 style="color: #666; font-size: 14px; margin: 0 0 10px 0;">í™œì„± íšŒë¡œ ë§µ</h3>
            <div id="bulb-grid" style="color: #444; font-size: 12px;">ì´ˆê¸°í™” ì¤‘...</div>
        </div>
    </div>

    <div id="tab-stats" class="tab-content container">
        <div class="panel" style="grid-column: span 2;">
            <div class="section-header">
                <h3 style="color: var(--neon); margin:0;">íš¨ê³¼ ë””ë ‰í† ë¦¬</h3>
            </div>
            <div class="sub-tab-nav">
                <button class="sub-tab-btn active" onclick="switchSubTab('spark')">ë°œìƒ</button>
                <button class="sub-tab-btn" onclick="switchSubTab('impulse')">ì¶©ë™</button>
                <button class="sub-tab-btn" onclick="switchSubTab('system')">ì‹œìŠ¤í…œ</button>
            </div>
            <div id="stats-list"></div>
        </div>
    </div>

    <div id="tab-settings" class="tab-content container">
        <div class="panel" style="grid-column: span 2;">
            <div class="setting-group">
                <div class="setting-title">ë°ì´í„° ê´€ë¦¬</div>
                <button class="setting-btn" onclick="saveGame(true)">ê°•ì œ ì €ì¥</button>
                <button class="setting-btn" onclick="resetGame()" style="color: #f88; border-color: #522;">ì „ì²´
                    ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <div class="log" id="game-log">> ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ.</div>

    <script>
        let bits = new Decimal(0);
        let hardware = { rows: 1, cols: 1, speed: 0 };
        let ranks = { spark: 0, impulse: 0 };
        let rankData = null; // JSONì—ì„œ ë¡œë“œë¨
        let activeSubTab = 'spark';

        function format(value, places = 3) {
            let d = new Decimal(value);
            if (d.lt(1e6)) {
                return d.floor().toString();
            }
            return d.toExponential(places).replace("+", "");
        }

        // rankData.json íŒŒì¼ì—ì„œ cognitive step ë°ì´í„° ë¡œë“œ
        async function loadRankData() {
            try {
                // í˜„ì¬ í˜ì´ì§€ì˜ ê²½ë¡œë¥¼ ê¸°ì¤€ìœ¼ë¡œ rankData.json ê²½ë¡œ ì„¤ì •
                const jsonPath = new URL('rankData.json', window.location.href).href;
                const response = await fetch(jsonPath);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                rankData = data;
                console.log('rankData ë¡œë“œ ì„±ê³µ:', rankData);
                return true;
            } catch (error) {
                console.error('rankData ë¡œë“œ ì‹¤íŒ¨:', error);
                console.error('ì‹œë„í•œ ê²½ë¡œ:', new URL('rankData.json', window.location.href).href);
                alert(`ê²Œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì—ëŸ¬: ${error.message}\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.`);
                return false;
            }
        }

        function saveGame(notify = false) {
            const saveObj = { bits: bits.toString(), hardware: hardware, ranks: ranks };
            localStorage.setItem('infCompSave', JSON.stringify(saveObj));
            if (notify) alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function loadGame() {
            const saveStr = localStorage.getItem('infCompSave');
            if (saveStr) {
                try {
                    const saveObj = JSON.parse(saveStr);
                    bits = new Decimal(saveObj.bits);
                    hardware = saveObj.hardware;
                    ranks = saveObj.ranks;
                    // í˜¸í™˜ì„±ì„ ìœ„í•œ ì˜ˆì™¸ ì²˜ë¦¬ (ì´ì „ ë²„ì „ì—ì„œ impulse/intuitionì´ì—ˆì„ ê²½ìš°)
                    if (saveObj.ranks.impulse !== undefined && saveObj.ranks.spark === undefined) {
                        ranks.spark = saveObj.ranks.impulse;
                        ranks.impulse = saveObj.ranks.intuition || 0;
                    }
                    addLog("ë°ì´í„° ë¡œë“œ ì™„ë£Œ.");
                } catch (e) { }
            }
        }

        window.resetGame = function () {
            if (confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('infCompSave');
                location.reload();
            }
        }

        // ìµœëŒ€ ê°€ë¡œ í¬ê¸° ê³„ì‚° (ê¸°ë³¸ 4, ë°œìƒ 5+ ë ˆë²¨ë§ˆë‹¤ +1)
        function getMaxCols() {
            let baseMax = 4;
            if (ranks.spark >= 5) {
                return Math.min(baseMax + (ranks.spark - 4), 8);
            }
            return baseMax;
        }

        const getHWCost = (type) => {
            let base = { rows: 50, cols: 5, speed: 10 }[type];
            let exp = { rows: 3.5, cols: 2.5, speed: 1.6 }[type];
            let lv = type === 'speed' ? hardware.speed : (type === 'rows' ? hardware.rows - 1 : hardware.cols - 1);

            if (ranks.spark >= 3) exp = 1 + (exp - 1) * 0.8;

            // í–‰(rows) ìŠ¤ì¼€ì¼ë§ ê°€ì† (Level 1ë¶€í„° ì ìš©)
            if (type === 'rows') {
                let currentLevel = hardware.rows - 1;
                // Level 1: adj=0 (Cost 50), Level 2: adj=2 (Cost 612), Level 3: adj=4.8 (Cost 21k)
                let adjustedExp = currentLevel + Math.pow(currentLevel, 1.5);
                return new Decimal(base).times(Decimal.pow(exp, adjustedExp)).floor();
            }

            // ê°€ë¡œ(cols) ë ˆë²¨ 5 ì´ìƒìœ¼ë¡œ ì˜¬ë¦´ ë•Œ ë¹„ìš© ì¦ê°€ìœ¨ ê°€ì†
            if (type === 'cols' && hardware.cols >= 5) {
                let currentLevel = hardware.cols - 1;
                // Level 5: adj=5 (Cost 488), Level 6: adj=7.8 (Cost 6.4k)
                let adjustedExp = currentLevel + Math.pow(currentLevel - 3, 1.5);
                return new Decimal(base).times(Decimal.pow(exp, adjustedExp)).floor();
            }

            return new Decimal(base).times(Decimal.pow(exp, lv)).floor();
        };

        const getRankCost = (id) => {
            if (id === 'impulse') return 0; // í•„ìš” Spark ë ˆë²¨ë¡œ ê³„ì‚°ë¨
            if (id === 'spark') {
                let exponent = Math.pow(ranks.spark, 7 / 6);
                return Decimal.pow(2.5, exponent).times(5).floor();
            }
            return new Decimal(rankData[id].baseCost).times(Decimal.pow(rankData[id].scale, ranks[id])).floor();
        }

        window.switchTab = function (tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const tabMap = { 'main': 0, 'stats': 1, 'settings': 2 };
            document.querySelectorAll('.tab-btn')[tabMap[tabName]].classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            if (tabName === 'stats') renderStats();
        }

        window.switchSubTab = function (subTabId) {
            activeSubTab = subTabId;
            document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                if (btn.innerText === (subTabId === 'spark' ? 'ë°œìƒ' : (subTabId === 'impulse' ? 'ì¶©ë™' : 'ì‹œìŠ¤í…œ'))) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            renderStats();
        }

        window.buyHW = function (type) {
            // ì„¸ë¡œ ìµœëŒ€ì¹˜: 4
            if (type === 'rows' && hardware.rows >= 4) return;

            // ê°€ë¡œ ìµœëŒ€ì¹˜: ê¸°ë³¸ 4, ë°œìƒ 5+ ë ˆë²¨ë§ˆë‹¤ +1
            if (type === 'cols' && hardware.cols >= getMaxCols()) return;

            let cost = getHWCost(type);
            if (bits.gte(cost)) {
                bits = bits.minus(cost);
                hardware[type]++;
                if (type !== 'speed') initGrid();
                updateUI();
                saveGame();
            }
        }

        window.rankUp = function (id) {
            if (id === 'spark') {
                let cost = getRankCost(id);
                if (bits.lt(cost)) return;

                bits = new Decimal(0);
                ranks.spark++;
                hardware = { rows: 1, cols: 1, speed: 0 };
                addLog(`ë°œìƒ Lv.${ranks.spark}: ì‚¬ê³  í™•ì¥.`);
            }
            else if (id === 'impulse') {
                let req = Math.pow(ranks.impulse + 2, 2);
                if (ranks.spark < req) return;

                ranks.impulse++;
                ranks.spark = 0;
                bits = new Decimal(0);
                hardware = { rows: 1, cols: 1, speed: 0 };
                addLog(`ì¶©ë™ Lv.${ranks.impulse}: ìƒìœ„ ì°¨ì› ì§„ì….`);
            }
            initGrid();
            updateUI();
            saveGame();
        }

        function calculateDelay(speedLevel) {
            let delay = 1000;
            for (let i = 0; i < speedLevel; i++) {
                if (i < 12) {
                    delay *= 0.87;
                } else {
                    delay *= 0.93;
                }
            }
            return delay;
        }

        function gameLoop() {
            let delay = calculateDelay(hardware.speed);
            // ìµœì†Œ ë”œë ˆì´ ì œí•œ: ë¸Œë¼ìš°ì € íƒ€ì´ë¨¸ í•´ìƒë„ì™€ ì„±ëŠ¥ì„ ê³ ë ¤í•˜ì—¬ 16ms (ì•½ 60fps)ë¡œ ì œí•œ
            // 4ms ë¯¸ë§Œì´ë©´ ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ ì˜¬ë¦¬ì§€ë§Œ, UI ì—…ë°ì´íŠ¸ ë¹ˆë„ë¥¼ ê³ ë ¤í•´ 16msê°€ ì ì ˆ
            delay = Math.max(delay, 16);
            processTick();
            updateUI();
            document.getElementById('cycle-speed').innerText = Math.floor(delay);
            setTimeout(gameLoop, delay);
        }

        function processTick() {
            let prob = 50;
            if (ranks.impulse >= 3) prob += 10;

            let onCount = 0;
            let total = hardware.rows * hardware.cols;
            for (let i = 0; i < total; i++) {
                if (Math.random() * 100 < prob) { onCount++; flash(i); }
            }

            if (onCount > 0) {
                let baseBonus = new Decimal(1);
                if (ranks.spark >= 4) {
                    baseBonus = new Decimal(ranks.spark * 0.5 + 1).times(ranks.impulse * 1 + 1);
                }

                let yieldMult = baseBonus;
                if (ranks.spark >= 5) yieldMult = yieldMult.times(2);

                let comboMult = new Decimal(1);
                if (ranks.impulse >= 2) {
                    let threshold = Math.ceil((hardware.rows * hardware.cols) / 2);
                    if (onCount > threshold) {
                        let bonusRaw = 1 + 1.2 ** (onCount - threshold);
                        if (bonusRaw > 100) {
                            bonusRaw = 100 + Math.pow(bonusRaw - 100, 0.5);
                        }
                        comboMult = new Decimal(bonusRaw);
                    }
                }

                bits = bits.plus(yieldMult.times(onCount).times(comboMult));
            }
        }

        function updateUI() {
            document.getElementById('bits').innerText = format(bits.floor());
            document.getElementById('lv-spark').innerText = ranks.spark;
            document.getElementById('lv-impulse').innerText = ranks.impulse;

            updateBtn('btn-spark', getRankCost('spark'), '');

            const impBtn = document.getElementById('btn-impulse');
            const reqSpark = Math.pow(ranks.impulse + 2, 2);
            impBtn.querySelector('.cost-text').innerText = `í•„ìš”: ë°œìƒ Lv.${reqSpark}`;
            if (ranks.spark >= reqSpark) impBtn.classList.add('affordable');
            else impBtn.classList.remove('affordable');
            impBtn.disabled = ranks.spark < reqSpark;

            // í•˜ë“œì›¨ì–´ ë²„íŠ¼ í•´ê¸ˆ ì¡°ê±´ ë³€ê²½
            // ì—´ í™•ì¥(cols)ì€ ë°œìƒ 1 ì´ìƒ
            if (ranks.spark >= 1) {
                document.getElementById('btn-cols').classList.remove('hidden');
            } else {
                document.getElementById('btn-cols').classList.add('hidden');
            }

            // í´ëŸ­ ê°€ì†ì€ ë°œìƒ 2 ì´ìƒ ìœ ì§€
            if (ranks.spark >= 2) {
                document.getElementById('btn-speed').classList.remove('hidden');
            } else {
                document.getElementById('btn-speed').classList.add('hidden');
            }

            // í–‰ í™•ì¥(rows)ì€ ì¶©ë™ 1 ì´ìƒ
            if (ranks.impulse >= 1) document.getElementById('btn-rows').classList.remove('hidden');
            else document.getElementById('btn-rows').classList.add('hidden');

            // ì¶©ë™ ë²„íŠ¼: ë°œìƒ 4 ì´ìƒì´ê±°ë‚˜, ì´ë¯¸ ì¶©ë™ì„ í•œ ë²ˆì´ë¼ë„ ì˜¬ë ¸ë‹¤ë©´ í‘œì‹œ
            if (ranks.spark >= 4 || ranks.impulse > 0) document.getElementById('btn-impulse').classList.remove('hidden');
            else document.getElementById('btn-impulse').classList.add('hidden');

            updateHWBtn('btn-rows', 'rows');
            updateHWBtn('btn-cols', 'cols');
            updateBtn('btn-speed', getHWCost('speed'), `ì§€ì—°ì‹œê°„: ${Math.floor(calculateDelay(hardware.speed))}ms -> ${Math.floor(calculateDelay(hardware.speed + 1))}ms`);

            if (bits.gte(10)) document.getElementById('bit-container').classList.add('affordable');
            else document.getElementById('bit-container').classList.remove('affordable');

            updateMilestones('spark');
            updateMilestones('impulse');
        }

        function updateHWBtn(id, type) {
            const btn = document.getElementById(id);
            let maxVal = type === 'cols' ? getMaxCols() : 4;

            if (hardware[type] >= maxVal) {
                btn.querySelector('.rank-title').innerText = type === 'cols' ? "ì—´ í™•ì¥ (ìµœëŒ€)" : "í–‰ í™•ì¥ (ìµœëŒ€)";
                btn.querySelector('.cost-text').innerText = "ìµœëŒ€";
                btn.querySelector('.effect-info').innerText = "ì œí•œ ë„ë‹¬";
                btn.classList.remove('affordable');
                btn.disabled = true;
            } else {
                updateBtn(id, getHWCost(type), `${type === 'rows' ? 'í–‰' : 'ì—´'}: ${hardware[type]} -> ${hardware[type] + 1} (ìµœëŒ€ ${maxVal})`);
            }
        }

        function updateBtn(id, cost, effectText) {
            const btn = document.getElementById(id);
            if (!btn || (btn.disabled && cost === 'MAX')) return;

            const costEl = btn.querySelector('.cost-text');
            const effEl = btn.querySelector('.effect-info');
            if (costEl) costEl.innerText = `ë¹„ìš©: ${format(cost)}`;
            if (effEl) effEl.innerText = effectText;

            if (bits.gte(cost)) btn.classList.add('affordable');
            else btn.classList.remove('affordable');
            btn.disabled = bits.lt(cost);
        }

        function updateMilestones(id) {
            const msContainer = document.getElementById(`ms-${id}`);
            const data = rankData[id].ms;
            const curLv = ranks[id];
            let active = data.filter(m => m.lv <= curLv).pop();
            let future = data.filter(m => m.lv > curLv).slice(0, active ? 2 : 3);
            let html = '';
            if (active) html += `<div class="ms-item ms-active">âœ” Lv.${active.lv}: ${active.desc}</div>`;
            future.forEach(m => { html += `<div class="ms-item ms-future">ğŸ”’ Lv.${m.lv}: ${m.desc}</div>`; });
            msContainer.innerHTML = html;
        }

        function renderStats() {
            const list = document.getElementById('stats-list');
            let html = '';

            if (activeSubTab === 'spark' || activeSubTab === 'impulse') {
                const type = activeSubTab;
                const curLv = ranks[type];
                if (curLv > 0) {
                    const activeMs = rankData[type].ms.filter(m => m.lv <= curLv);
                    activeMs.forEach(m => {
                        let desc = m.desc;
                        let detailText = m.detail || '';

                        // Dynamic descriptions
                        if (type === 'spark' && m.lv === 4) {
                            let sBonus = ranks.spark * 0.5 + 1;
                            let iBonus = ranks.impulse * 1 + 1;
                            let total = sBonus * iBonus;
                            detailText += `<br><br><b>í˜„ì¬ ìƒíƒœ:</b><br>ìµœì¢… ë³´ë„ˆìŠ¤: x${format(total, 3)}<br>(ë°œìƒ: x${sBonus.toFixed(1)} * ì¶©ë™: x${iBonus.toFixed(1)})`;
                        }

                        const helpBtn = detailText ? `<button class="help-btn">? <span class="tooltip">${detailText}</span></button>` : '';
                        html += `<div class="stat-line"><span class="stat-label">[Lv.${m.lv}]</span> ${desc}${helpBtn}</div>`;
                    });
                }
            } else if (activeSubTab === 'system') {
                // System/General stats
                if (ranks.spark >= 4) {
                    let sBonus = ranks.spark * 0.5 + 1;
                    let iBonus = ranks.impulse * 1 + 1;
                    let total = sBonus * iBonus;
                    const bonusDetail = `ê¸°ë³¸ ìƒì‚°ëŸ‰ì´ (ë°œìƒ ë ˆë²¨ * 0.5 + 1) Ã— (ì¶©ë™ ë ˆë²¨ * 1 + 1)ë§Œí¼ ê³±ì—°ì‚°ë©ë‹ˆë‹¤.<br>í˜„ì¬: x${sBonus.toFixed(1)} * x${iBonus.toFixed(1)} = x${format(total, 3)}`;
                    html += `<div class="stat-line"><span class="stat-label">[íš¨ê³¼]</span> ê¸°ë³¸ ìƒì‚°ëŸ‰ ë³´ë„ˆìŠ¤: x${format(total, 3)}<button class="help-btn">? <span class="tooltip">${bonusDetail}</span></button></div>`;
                }
                if (ranks.impulse >= 2) {
                    let threshold = Math.ceil((hardware.rows * hardware.cols) / 2);
                    const comboDetail = `ì „êµ¬ ê°œìˆ˜ì˜ 50%(${threshold}ê°œ) ì´ìƒì´ ì¼œì§ˆ ë•Œë¶€í„° ì¶”ê°€ ë³´ë„ˆìŠ¤ê°€ ë°œìƒí•©ë‹ˆë‹¤.`;
                    html += `<div class="stat-line"><span class="stat-label">[íš¨ê³¼]</span> ì½¤ë³´ ì‹œë„ˆì§€ ì„ê³„ì¹˜: ${threshold}ê°œ<button class="help-btn">? <span class="tooltip">${comboDetail}</span></button></div>`;
                }
            }

            if (html === '') html = '<div style="padding:10px; color:#666;">í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— í™œì„±í™”ëœ íš¨ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            list.innerHTML = html;
        }

        function initGrid() {
            const grid = document.getElementById('bulb-grid');
            if (!grid) return;
            grid.style.gridTemplateColumns = `repeat(${hardware.cols}, 1fr)`;
            grid.innerHTML = '';
            for (let i = 0; i < hardware.rows * hardware.cols; i++) {
                let b = document.createElement('div'); b.className = 'bulb'; b.id = `bulb-${i}`;
                grid.appendChild(b);
            }
        }

        function flash(id) {
            const el = document.getElementById(`bulb-${id}`);
            if (el) { el.classList.add('on'); setTimeout(() => el.classList.remove('on'), 100); }
        }

        function addLog(msg) {
            const log = document.getElementById('game-log');
            log.innerHTML = `> ${msg}<br>${log.innerHTML}`;
        }

        // ìë™ ì €ì¥ (1ë¶„ë§ˆë‹¤)
        setInterval(() => {
            saveGame();
        }, 60000);

        // ê²Œì„ ì´ˆê¸°í™”: rankData ë¡œë“œ í›„ ê²Œì„ ì‹œì‘
        window.onload = async () => {
            const loaded = await loadRankData();
            if (loaded) {
                loadGame();
                initGrid();
                gameLoop();
            }
        };
    </script>
</body>

</html>